<!DOCTYPE html>
<html lang='en'>
    <head>
        <title>Wh00t</title>
        <meta charset='UTF-8'>
        <link rel="apple-touch-icon" sizes="180x180" href="../img/favicon_io/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="../img/favicon_io/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="../img/favicon_io/favicon-16x16.png">
        <link rel="manifest" href="../img/favicon_io/site.webmanifest">
        <link rel='stylesheet' href='../main.css'>
        <link rel='stylesheet' href='../index.css'>
        <link rel='stylesheet' href='wh00t.css'>
    </head>
    <body>
        <div id='app_container'>
            <div class='header no_display-600-s no_border'>
                <div class='title'>
                    <h1>Wh00t</h1>
                    <div id='update_time' class='no_display-700-s'>no automatic update</div>
                </div>
                <div class='nav_links'>
                    <div class='nav_container'>
                        <a class='button' href='../'>/</a>
                        <a class='button' href='../air/'>Air</a>
                        <a class='button' href='../lexicon/'>Lexicon</a>
                        <a class='button active' href='../wh00t/'>Wh00t</a>
                        <a class='button' href='../debug/'>Debug</a>
                    </div>
                </div>
            </div>
            <div class='screen_name_spacer no_display-700-s'>
                <h3>Screename: <span id='ws-id'></span></h3>
            </div>
            <div id='wh00t_img' class='no_display-700-s'></div>
            <button class='send_button no_display-700-s wh00t_pop_out_button' type='button' onclick='open_popup()'>
                <i class='arrow right'></i>
            </button>
            <div id='wh00t_container'></div>
            <script>
                const randomIntFromInterval = (min, max) => { // min and max included
                    return Math.floor(Math.random() * (max - min + 1) + min)
                }

                Notification.requestPermission();
                const wh00t_container = document.getElementById('wh00t_container');
                const wh00t_message_alert_sound = new Audio('../audio/wh00t7.wav');
                const update_time_container = document.getElementById('update_time');
                const url_regex =/((http|ftp|https):\/\/)?([\w_-]+(?:\.[\w_-]+)+)([\w.,@?^=%&:/~+#-]*[\w@?^=%&/~+#-])?/ig;
                let key_log = {}
                let client_id_prefix = ['rabbit', 'raven', 'honeyBadger', 'panda', 'meerkat', 'kitty', 'guineaPig',
                    'penguin', 'racoon', 'owl']
                let client_id = client_id_prefix[randomIntFromInterval(0, client_id_prefix.length-1)] + randomIntFromInterval(1, 99)
                document.querySelector('#ws-id').textContent = client_id;
                let ws = new WebSocket(`ws://${location.hostname}:8000/wh00t_chat/${client_id}`);

                ws.onopen = (event) => {
                    handleMessage({
                        username: 'web_client',
                        time: 'Now',
                        message: `connected to wh00t as ${client_id}`
                    }, wh00t_container, 'live')
                }

                ws.onerror = (event) => {
                    handleMessage({
                        username: 'web_client',
                        time: 'Now',
                        message: `an error has occured connecting to wh00t`
                    }, wh00t_container, 'live')
                }

                ws.onmessage = (event) => {
                    let parsed_data = JSON.parse(event.data)
                    if (Array.isArray(parsed_data)){
                        for (let index in parsed_data){
                            handleMessage(parsed_data[index], wh00t_container, 'history')
                        }
                    }
                    else{
                        handleMessage(parsed_data, wh00t_container, 'live')
                        update_time_container.innerText = `last message @ ${parsed_data.time}`
                    }
                };

                const handleMessage = (wh00t_message, wh00t_container, message_context) => {
                    let message_container = document.createElement('div')
                    let message_username_container = document.createElement('span')
                    let message_text_container = document.createElement('span')
                    message_text_container.classList.add('message_text')
                    let message_prefix
                    if (wh00t_message.username === client_id){
                        message_username_container.classList.add('wh00t_username_color')
                        message_prefix = `${wh00t_message.username} ${wh00t_message.time}: `
                    }
                    else if (wh00t_message.username === 'web_client'){
                        message_prefix = `${wh00t_message.time} `
                    }
                    else{
                        message_prefix = `${wh00t_message.username} ${wh00t_message.time}: `
                        message_username_container.classList.add('wh00t_other_usernames_color')
                        if (Notification.permission === 'granted' && message_context === 'live'){
                            let notification = new Notification('wh00t_web',{
                                body: `${wh00t_message.username}: ${wh00t_message.message}`,
                                icon: '../img/icon.png'
                            });
                            wh00t_message_alert_sound.play();
                            setTimeout(() => notification.close(), 5*1000);
                        }
                    }
                    message_username_container.innerText = message_prefix
                    message_container.appendChild(message_username_container)
                    if(is_image_link(wh00t_message.message)){
                        message_container.appendChild(image_generator(wh00t_message.message))
                        wh00t_container.appendChild(message_container)
                        const scroll_down_time_out = setTimeout(() => {
                            wh00t_container.scrollTop = wh00t_container.scrollHeight;
                        },250);
                    }
                    else{
                        message_text_container.innerHTML = linkify(wh00t_message.message)
                        message_container.appendChild(message_text_container)
                        wh00t_container.appendChild(message_container)
                        wh00t_container.scrollTop = wh00t_container.scrollHeight;
                    }
                }

                const sendMessage = (event) => {
                    let input = document.getElementById('messageText')
                    if(input.value !== '') {
                        ws.send(input.value)
                        input.value = ''
                    }
                    event.preventDefault()
                }

                const key_handler = (event) => {
                    key_log[event.key] = (event.type === 'keydown');
                    if(event.type === 'keydown'){
                        if ((!key_log.Shift || key_log.Shift === false) && key_log.Enter === true) {
                            sendMessage(event)
                        }
                    }
                }

                const open_popup = () => {
                    let params = `directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=575,height=475'`;
                    window.open(`http://${location.hostname}:8080/wh00t/`, 'test', params)
                    open(`http://${location.hostname}:8080/`, '_self');
                }

                const linkify = (message) => {
                    if(!message) return;
                    return message.replace(url_regex, function (url) {
                        let hyperlink = url;
                        if (!hyperlink.match('^https?:\/\/')) {
                            hyperlink = 'https://' + hyperlink;
                        }
                        return '<a href="' + hyperlink + '" target="_blank" rel="noopener noreferrer">' + url + '</a>'
                    });
                }

                const is_image_link = (text) =>{
                    // TODO: add check for a valid url address before image suffix test
                    return (text.endsWith('.png') || text.endsWith('.jpg') || text.endsWith('.jpeg') ||
                            text.endsWith('.webp') || text.endsWith('.gif'));
                }

                const image_generator = (image_link) => {
                    const img = new Image();
                    img.src = image_link;
                    return img
                }
            </script>
            <div id='wh00t_chat_input'>
                <form class='wh00t_chat_form' onsubmit='sendMessage(event)'>
                    <textarea rows='1'
                              class='message_input'
                              placeholder='Message'
                              id='messageText'
                              onkeydown='key_handler(event)'
                              onkeyup='key_handler(event)'
                              autocomplete='off'
                              autofocus
                    ></textarea>
                    <button class='send_button' type='button' onclick='sendMessage(event)'>
                        Send
                    </button>
                </form>
            </div>
        </div>
    </body>
</html>